<script>
// ================== CONFIG ==================
const CONFIG = {
  maxLinksPerColumn: 18,
  totalMaxLinks: 54,
  storageKey: 'dayluge_links_v3'
};

// ================== DATA ==================
const INITIAL_DATA = { /* (same as before; keep your original INITIAL_DATA block) */ };

// ================== MANAGER ==================
class DayLugeManager {
  constructor() {
    this.data = this.loadData();
    this.activeTab = 1; // 1..3
    this.mobileQuery = window.matchMedia('(max-width: 640px)');
    this.init();
  }

  loadData() {
    try {
      const stored = localStorage.getItem(CONFIG.storageKey);
      return stored ? JSON.parse(stored) : INITIAL_DATA;
    } catch (e) {
      return INITIAL_DATA;
    }
  }

  saveData() {
    try {
      localStorage.setItem(CONFIG.storageKey, JSON.stringify(this.data));
    } catch (e) {}
  }

  init() {
    this.render();
    this.updateStats();
    this.mobileQuery.addEventListener?.('change', () => this.updateMobileVisibility());
    window.addEventListener('orientationchange', () => this.updateMobileVisibility());
    window.addEventListener('resize', () => this.updateMobileVisibility());
    this.updateMobileVisibility(true);
  }

  addLink(columnNum, linkData) {
    const columnKey = `column${columnNum}`;
    linkData.dateAdded = new Date().toISOString();
    this.data[columnKey].unshift(linkData);
    this.enforceColumnLimit(columnKey);
    this.saveData();
    this.render();
    this.updateStats();
  }

  enforceColumnLimit(columnKey) {
    const column = this.data[columnKey];
    if (column.length > CONFIG.maxLinksPerColumn) {
      const excess = column.splice(CONFIG.maxLinksPerColumn);
      excess.forEach(link => {
        link.archivedDate = new Date().toISOString();
        link.originalColumn = columnKey;
        this.data.archived.push(link);
      });
    }
  }

  render() {
    for (let i = 1; i <= 3; i++) {
      const columnKey = `column${i}`;
      const links = this.data[columnKey] || [];
      const target = document.getElementById(`col-${i}`);
      if (!target) continue;
      let html = '';
      links.forEach(link => {
        html += `<div class="link-item"><a href="${link.url}" class="${link.color || ''}" target="_blank" rel="noopener noreferrer">${link.title}</a></div>`;
      });
      target.innerHTML = html;
    }
    this.updateMobileVisibility();
  }

  updateStats() {
    const totalActive =
      (this.data.column1?.length || 0) +
      (this.data.column2?.length || 0) +
      (this.data.column3?.length || 0);
    const totalArchived = this.data.archived.length;
    document.getElementById('totalLinks').textContent =
      `Active: ${totalActive}/${CONFIG.totalMaxLinks} | Archived: ${totalArchived}`;
    const countsDiv = document.getElementById('linkCounts');
    if (countsDiv) {
      countsDiv.innerHTML = `
        Col 1: ${this.data.column1.length}/${CONFIG.maxLinksPerColumn}<br>
        Col 2: ${this.data.column2.length}/${CONFIG.maxLinksPerColumn}<br>
        Col 3: ${this.data.column3.length}/${CONFIG.maxLinksPerColumn}<br>
        <strong>Total: ${totalActive}/${CONFIG.totalMaxLinks}</strong>
      `;
    }
  }

  forceArchiveOld() {
    let totalArchived = 0;
    ['column1', 'column2', 'column3'].forEach(columnKey => {
      const column = this.data[columnKey];
      if (column.length > 10) {
        const toArchive = column.splice(10);
        toArchive.forEach(link => {
          link.archivedDate = new Date().toISOString();
          link.originalColumn = columnKey;
          this.data.archived.push(link);
        });
        totalArchived += toArchive.length;
      }
    });
    this.saveData();
    this.render();
    this.updateStats();
    alert(`Archived ${totalArchived} older links`);
  }

  addSampleLink() {
    const colors = ['c-red', 'c-orange', 'c-green', 'c-blue', 'c-indigo', 'c-violet', 'c-pink'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    const randomColumn = Math.floor(Math.random() * 3) + 1;
    const sampleLink = {
      url: 'https://example.com/sample-' + Date.now(),
      title: `Sample Link Added ${new Date().toLocaleTimeString()}`,
      color: randomColor
    };
    this.addLink(randomColumn, sampleLink);
  }

  exportData() {
    const dataStr = JSON.stringify(this.data, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'dayluge-data.json';
    link.click();
    URL.revokeObjectURL(url);
  }

  clearAll() {
    if (confirm('Are you sure you want to clear all data?')) {
      this.data = { column1: [], column2: [], column3: [], archived: [] };
      this.saveData();
      this.render();
      this.updateStats();
    }
  }
}

// ================== GLOBAL HOOKS ==================
let dayLugeManager;

function toggleAdmin() {
  const panel = document.getElementById('adminControls');
  panel.classList.toggle('show');
}
function addSampleLink() { dayLugeManager.addSampleLink(); }
function forceArchive()   { dayLugeManager.forceArchiveOld(); }
function exportData()     { dayLugeManager.exportData(); }
function clearAll()       { dayLugeManager.clearAll(); }

function setActiveTab(n){
  dayLugeManager.activeTab = Math.max(1, Math.min(3, Number(n) || 1));
  updateTabsUI();
  updateColumnVisibility();

  // âœ… Scroll to the selected column (mobile only)
  if (isMobile()) {
    const wrap = document.getElementById(`colwrap-${dayLugeManager.activeTab}`);
    if (wrap) {
      wrap.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
}

function isMobile(){
  return window.matchMedia('(max-width: 640px)').matches;
}

function updateTabsUI(){
  for (let i=1;i<=3;i++){
    const btn = document.getElementById(`tab-${i}`);
    if (!btn) continue;
    if (i === dayLugeManager.activeTab) {
      btn.classList.add('tab-active');
      btn.setAttribute('aria-selected','true');
    } else {
      btn.classList.remove('tab-active');
      btn.setAttribute('aria-selected','false');
    }
  }
}

function updateColumnVisibility(){
  const mobile = isMobile();
  for (let i=1;i<=3;i++){
    const wrap = document.getElementById(`colwrap-${i}`);
    if (!wrap) continue;
    if (mobile) {
      if (i === dayLugeManager.activeTab) wrap.classList.remove('hidden');
      else wrap.classList.add('hidden');
    } else {
      wrap.classList.remove('hidden');
    }
  }
}

function updateMobileVisibility(initial=false){
  updateTabsUI();
  updateColumnVisibility();
  if (initial && isMobile()) setActiveTab(1);
}

window.updateMobileVisibility = updateMobileVisibility;

document.addEventListener('DOMContentLoaded', function() {
  dayLugeManager = new DayLugeManager();
  if (isMobile()) setActiveTab(1);
});
</script>
