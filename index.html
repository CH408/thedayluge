window.goToRandomArticle = function() {
  // Open a blank window immediately (tied to click gesture)
  const newWindow = window.open('', '_blank');
  
  // If blocked, bail out (user can retry or check popup settings)
  if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
      console.error('Popup blocked. Please allow popups for this site.');
      return;
  }

  // Now do the async work and navigate the window
  fetch('surprise-me-links.txt')
      .then(response => {
          if (!response.ok) {
              throw new Error(`HTTP ${response.status}: Failed to load surprise-me-links.txt`);
          }
          return response.text();
      })
      .then(text => {
          const lines = text.split('\n').filter(line => line.trim());
          const links = lines.map(line => {
              const parts = line.split('|');
              if (parts.length >= 2) {
                  return parts[1].trim();
              }
              return null;
          }).filter(link => link !== null);
          
          // Use only the first 5 links (most recent)
          const surpriseLinks = links.slice(0, 5);
          
          if (surpriseLinks.length > 0) {
              const randomLink = surpriseLinks[Math.floor(Math.random() * surpriseLinks.length)];
              newWindow.location.href = randomLink;  // Navigate the open window
          } else {
              throw new Error('No valid links found in surprise-me-links.txt (need at least 5)');
          }
      })
      .catch(error => {
          console.error('Error loading surprise me links:', error);
          if (newWindow && !newWindow.closed) {
              newWindow.close();  // Clean up the blank window on error
          }
      });
};
