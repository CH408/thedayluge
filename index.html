<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The DayLuge — Keep Every Link + Import if Needed</title>
<style>
  :root{
    --red:#cc0000; --orange:#ff6600; --green:#009900; --lime:#32cd32;
    --blue:#3388cc; --light-blue:#000080; --indigo:#4b0082; --violet:#6600cc; --pink:#ff3399;
    --ink:#111827; --muted:#6b7280; --bg:#f3f4f6; --paper:#fff; --rule:#e5e7eb;
    --maxw:1400px;
  }

  /* Color classes */
  .c-red{color:var(--red)} .c-orange{color:var(--orange)} .c-green{color:var(--green)}
  .c-lime-green{color:var(--lime)} .c-blue{color:var(--blue)} .c-light-blue{color:var(--light-blue)}
  .c-indigo{color:var(--indigo)} .c-violet{color:var(--violet)} .c-pink{color:var(--pink)}
  .c-purple{color:var(--violet)} .c-black{color:#000}

  *{box-sizing:border-box}
  body{margin:0; font-family:"Courier New",monospace; background:var(--bg); color:var(--ink)}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:20px}
  header{text-align:center; margin-bottom:16px}
  h1{margin:0; font-size:32px; letter-spacing:1px}
  nav{text-align:center; margin-bottom:20px; border-bottom:1px solid var(--rule); padding-bottom:12px}
  nav a{margin:0 12px; text-decoration:none; font-weight:bold; color:#333}
  nav a:hover{text-decoration:underline}

  .bar{
    display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; justify-content:space-between; align-items:center;
  }
  .bar .left, .bar .right{display:flex; gap:6px; flex-wrap:wrap; align-items:center}
  input[type="text"], select, textarea{
    border:1px solid var(--rule); border-radius:6px; padding:8px 10px; font-size:14px; background:#fff;
  }
  textarea{ width:100%; min-height:120px; font-family:monospace }

  button{
    border:1px solid var(--rule); border-radius:6px; padding:8px 12px; background:#fff; cursor:pointer;
  }
  button:hover{background:#f2f2f2}
  .meter{font-size:12px; color:var(--muted)}

  /* Grid: row-wise flow (left→right→down), responsive columns */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:16px;
  }
  .link{
    background:var(--paper); border:1px solid var(--rule); border-radius:8px; padding:10px 12px;
    font-weight:bold; font-size:18px;
  }
  .link a{text-decoration:none; color:inherit; display:block; word-break:break-word}
  .link a:hover{text-decoration:underline}
  .time{font-size:12px; color:var(--muted); margin-top:4px}

  .empty{ color:var(--muted); text-align:center; padding:30px 0; }

  .import-panel{
    background:#fff; border:1px solid var(--rule); border-radius:10px; padding:12px; margin-bottom:14px;
  }
  .import-row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  .import-note{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>THE DAYLUGE</h1></header>
  <nav><a href="/">Home</a> <a href="/archive">Archive</a></nav>

  <!-- Migration Report + Import Helpers -->
  <div id="importPanel" class="import-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;">
      <strong>Migration Report</strong>
      <button id="hideImportBtn" title="Hide">Hide</button>
    </div>
    <div id="migrationReport" class="import-note">Checking old storage…</div>
    <div class="import-row" style="margin-top:8px;">
      <input type="file" id="fileInput" accept="application/json" />
      <button id="importFileBtn">Import from file</button>
      <button id="showPasteBtn">Paste JSON…</button>
      <button id="backupOldBtn" title="Download old 3-col storage (if present)">Backup old</button>
    </div>
    <div id="pasteBox" style="display:none; margin-top:8px;">
      <textarea id="pasteArea" placeholder='Paste the JSON from your old site’s localStorage["dayluge_links_v3"] here…'></textarea>
      <div class="import-row" style="margin-top:6px;">
        <button id="importPasteBtn">Import pasted JSON</button>
        <span class="import-note">Tip: open the old site, DevTools → Console → copy localStorage["dayluge_links_v3"]</span>
      </div>
    </div>
  </div>

  <div class="bar">
    <div class="left">
      <input id="titleInput" type="text" placeholder="Title">
      <input id="urlInput" type="text" placeholder="URL">
      <select id="colorInput" title="color">
        <option value="c-black">(black)</option>
        <option value="c-red">red</option>
        <option value="c-orange">orange</option>
        <option value="c-green">green</option>
        <option value="c-lime-green">lime</option>
        <option value="c-blue">blue</option>
        <option value="c-light-blue">light blue</option>
        <option value="c-indigo">indigo</option>
        <option value="c-violet">violet</option>
        <option value="c-pink">pink</option>
        <option value="c-purple">purple</option>
      </select>
      <button id="addBtn">Add link</button>
    </div>
    <div class="right">
      <button id="toggleBtn">View Archive</button>
      <button id="exportActiveBtn" title="Download active JSON">Export Active</button>
      <button id="exportArchiveBtn" title="Download archive JSON">Export Archive</button>
      <span class="meter" id="counts"></span>
    </div>
  </div>

  <div class="grid" id="feed"></div>
  <div id="emptyMsg" class="empty" style="display:none">No links yet.</div>
</div>

<script>
/** Keys **/
const OLD_KEYS = [
  'dayluge_links_v3',  // your old code
  'dayluge_links_v2',
  'dayluge_links_v1'
];
const ACTIVE_KEY = 'dayluge_active_v1';
const ARCHIVE_KEY = 'dayluge_archive_v1';
const ACTIVE_MAX = 48;

/** Utils **/
function loadJSON(key){ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):null; }catch(e){ return null; } }
function saveJSON(key,v){ localStorage.setItem(key, JSON.stringify(v)); }

/** Normalizers **/
function normalizeOld3Col(old){
  // Expecting {column1, column2, column3, archived?}
  if (!old || typeof old!=='object') return [];
  const merged = []
    .concat(old.column1||[], old.column2||[], old.column3||[])
    .map(l => ({
      title: l?.title || '(untitled)',
      url: l?.url || '#',
      color: l?.color || 'c-black',
      timestamp: l?.dateAdded || l?.timestamp || new Date().toISOString()
    }));
  // newest first
  merged.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
  return merged;
}

function renderMigrationReport(foundOldKey, oldCount, activeCount, archiveCount){
  const rep = document.getElementById('migrationReport');
  rep.textContent = foundOldKey
    ? `Found old storage "${foundOldKey}" with ${oldCount} visible links. Active=${activeCount} | Archive=${archiveCount}.`
    : `No old storage found on this origin. Active=${activeCount} | Archive=${archiveCount}. If your links are on another URL, use Import.`;
}

/** Migration on this origin (non-destructive) **/
function migrateIfNeeded(){
  let active = loadJSON(ACTIVE_KEY);
  let archive = loadJSON(ARCHIVE_KEY);
  let foundKey = null;
  if (!Array.isArray(active)) active = [];
  if (!Array.isArray(archive)) archive = [];

  if (active.length===0){
    for (const k of OLD_KEYS){
      const old = loadJSON(k);
      if (old){
        const list = normalizeOld3Col(old);
        active = list; // exact visible links only
        foundKey = k;
        break;
      }
    }
  }

  // Save back
  saveJSON(ACTIVE_KEY, active);
  saveJSON(ARCHIVE_KEY, archive);

  renderMigrationReport(foundKey, (active||[]).length, active.length, archive.length);
  return {active, archive};
}

/** State **/
let {active, archive} = migrateIfNeeded();
let showingArchive = false;

const feedEl = document.getElementById('feed');
const countsEl = document.getElementById('counts');
const emptyMsg = document.getElementById('emptyMsg');
const fmtTime = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'});

/** Cap logic: keep newest 48 in Active; move any overflow to Archive (oldest active moves). **/
function enforceActiveCap(){
  if (active.length > ACTIVE_MAX){
    const overflow = active.splice(ACTIVE_MAX); // these are the oldest in active
    // Put overflow at the FRONT of archive (so archive is newest-first too)
    // overflow is oldest-first; reverse so newest-first when unshifting
    overflow.reverse().forEach(item => archive.unshift(item));
  }
}

function render(){
  const list = showingArchive ? archive : active;
  feedEl.innerHTML = list.map(l => `
    <div class="link ${l.color || 'c-black'}">
      <a href="${l.url}" target="_blank" rel="noopener">${l.title}</a>
      <div class="time">${fmtTime.format(new Date(l.timestamp))}</div>
    </div>
  `).join('');

  emptyMsg.style.display = list.length ? 'none' : 'block';

  countsEl.textContent = showingArchive
    ? `Archive: ${archive.length} | Active: ${active.length}/${ACTIVE_MAX}`
    : `Active: ${active.length}/${ACTIVE_MAX} | Archive: ${archive.length}`;

  document.getElementById('toggleBtn').textContent = showingArchive ? 'View Active' : 'View Archive';
}

/** Add link (newest first) **/
function addLink(title, url, color){
  const item = {
    title: title || '(untitled)',
    url: url || '#',
    color: color || 'c-black',
    timestamp: new Date().toISOString()
  };
  active.unshift(item);
  enforceActiveCap();
  saveJSON(ACTIVE_KEY, active);
  saveJSON(ARCHIVE_KEY, archive);
  showingArchive = false;
  render();
  window.scrollTo({top:0, behavior:'smooth'});
}

/** Import helpers **/
function importFromOldJSON(obj){
  try{
    const list = normalizeOld3Col(obj);
    // Replace active exactly with this list (your request: “exact links already entered and no more”)
    active = list;
    saveJSON(ACTIVE_KEY, active);
    renderMigrationReport('pasted/file import', active.length, active.length, (archive||[]).length);
    render();
    alert(`Imported ${active.length} links into Active.`);
  }catch(e){
    alert('Import failed. Check JSON format.');
  }
}

/** UI wiring **/
document.getElementById('addBtn').addEventListener('click', () => {
  const title = document.getElementById('titleInput').value.trim();
  const url   = document.getElementById('urlInput').value.trim();
  const color = document.getElementById('colorInput').value || 'c-black';
  if (!title || !url) { alert('Please enter both Title and URL'); return; }
  addLink(title, url, color);
  document.getElementById('titleInput').value = '';
  document.getElementById('urlInput').value = '';
  document.getElementById('colorInput').value = 'c-black';
});

document.getElementById('exportActiveBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(active, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dayluge-active.json'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('exportArchiveBtn').addEventListener('click', () => {
  const blob = new Blob([JSON.stringify(archive, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dayluge-archive.json'; a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('toggleBtn').addEventListener('click', () => {
  showingArchive = !showingArchive;
  render();
});

/* Import panel controls */
document.getElementById('hideImportBtn').addEventListener('click', ()=>{
  document.getElementById('importPanel').style.display='none';
});

document.getElementById('showPasteBtn').addEventListener('click', ()=>{
  const box = document.getElementById('pasteBox');
  box.style.display = box.style.display==='none' ? 'block' : 'none';
});

document.getElementById('importPasteBtn').addEventListener('click', ()=>{
  try{
    const txt = document.getElementById('pasteArea').value.trim();
    if (!txt){ alert('Paste JSON first'); return; }
    const obj = JSON.parse(txt);
    importFromOldJSON(obj);
  }catch(e){
    alert('Invalid JSON.');
  }
});

document.getElementById('importFileBtn').addEventListener('click', ()=>{
  const inp = document.getElementById('fileInput');
  if (!inp.files || !inp.files[0]){ alert('Choose a JSON file first.'); return; }
  const file = inp.files[0];
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const obj = JSON.parse(e.target.result);
      importFromOldJSON(obj);
    }catch(err){
      alert('Invalid JSON in file.');
    }
  };
  reader.readAsText(file);
});

/* Backup old 3-col storage (if present) */
document.getElementById('backupOldBtn').addEventListener('click', ()=>{
  let found=null;
  for (const k of OLD_KEYS){ const v=loadJSON(k); if (v){ found=v; break; } }
  if (!found){ alert('No old storage found on this origin.'); return; }
  const blob = new Blob([JSON.stringify(found, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dayluge-old-3col-backup.json'; a.click();
  URL.revokeObjectURL(url);
});

/** First paint **/
render();
</script>
</body>
</html>
